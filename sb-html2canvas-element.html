<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="sb-html2canvas-import.html">

<!--
Element wrapper for the html2canvas library..

Example:

    <sb-html2canvas-element id="imageGenerator" container="ContainerID"></sb-html2canvas-element>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="sb-html2canvas-element">
  <template>
    <iron-ajax
      id="base64API"
      method="POST"
      content-type="application/x-www-form-urlencoded"
      url="[[url]]"
      handle-as="json"
      on-response="_imageUrlGenerated">
    </iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'sb-html2canvas-element',

      properties: {

        /**
         * Url of the base64 to image file download api
         * TODO: image creation doesn't really belong in this element.
         * Create `sb-base64-to-image-element`
         */
        url: {
          type: String,
          value: 'https://safe-wave-14056.herokuapp.com/base64'
        },

        /**
         * The id (parent container) of the element to generate image from
         */
        container: {
          type: String
        },

        /**
         * Additional debugging output from html2canvas
         */
        debugMode: {
          type: Boolean,
          value: false
        }
      },

      // Element Lifecycle

      ready: function() {
        if (!window.html2canvas) {
          throw 'Requires html2canvas lib! - https://html2canvas.hertzen.com/';
        }
      },

      attached: function() {
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
      },

      detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
      },

      // Element Behavior

      /**
       * Hit our base64API Url after getting the base64 string from the html2canvas lib
       *
       */
      generateImage: function() {
        var containerEle = document.getElementById(this.container);
        if(!containerEle) {
          throw 'Container ID is invalid!';
        }

        (function(elementObj) {
          html2canvas(containerEle, {
            logging: elementObj.debugMode,
            useCORS: true,
            onrendered: function(canvas) {
              elementObj.$.base64API.body = {
                'base64': canvas.toDataURL('image/png')
              };
              if(elementObj.debugMode) {
                console.log('==== DEBUG base64 Start ====');
                console.log(self.$.base64API.body.base64);
                console.log('==== DEBUG base64 End ====');
              }

              // TODO: image creation doesn't really belong in this element.
              // Create `sb-base64-to-image-element`
              elementObj.$.base64API.generateRequest();
            }
          });
        })(this);

      },

      /**
       * The `sb-html2canvas-element-created` event is fired whenever `_imageUrlGenerated` is called.
       * This happens when the api returns a valid shortUrl Image path
       *
       * @event sb-html2canvas-element-created
       * @detail {{imageUrl: String}}
       */

      /**
       * Notify about an image creation
       * TODO: image creation doesn't really belong in this element.
       * Create `sb-base64-to-image-element`
       */
      _imageUrlGenerated: function(e, detail) {
        this.fire('sb-html2canvas-element-created', {
          imageUrl: detail.xhr.response.imageURL
        });
      },
    });
  </script>
</dom-module>
